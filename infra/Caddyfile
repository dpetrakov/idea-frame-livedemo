# Глобальные настройки Caddy
{
	# Email для Let's Encrypt (если указан)
	{$ACME_EMAIL:email off}
	
	# Автоматическое сжатие HTTP/3
	servers {
		protocols h1 h2 h3
	}
}

# Конфигурация для HTTPS (production)
{$DOMAIN:localhost} {
	# Автоматическое получение сертификатов от Let's Encrypt
	# Для localhost будет использован самоподписанный сертификат
	
	# Алиас для health check (для совместимости с acceptance критерием)
	@health_alias {
		path /api/health
	}
	rewrite @health_alias /api/v1/health

	# Проксирование API запросов к backend
	handle /api/* {
		reverse_proxy backend:8080 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Проксирование всех остальных запросов к frontend
	handle {
		reverse_proxy frontend:80 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Заголовки безопасности
	header {
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
	}

	# Логирование
	log {
		output stdout
		format json
	}
}

# HTTP редирект на HTTPS
http://{$DOMAIN:localhost} {
	redir https://{host}{uri} permanent
}
