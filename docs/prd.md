# PRD: Система фрейминга портфеля инициатив

## 1. Контекст и цели
- Инструмент для фиксации и обсуждения инициатив (идей/фич), их быстрой оценки и приоритизации.
- В рамках демо: простой веб‑клиент с мобильным UX по умолчанию и минимальным бэкендом.
- Цель: за 1–2 минуты создать инициативу, получить обратную связь и оценку, увидеть приоритет.
- Успех: пользователи создают инициативы, оценивают их по шкалам и сортируют по весу без инструкций.

## 2. Роли и персоны
- Пользователь: может регистрироваться/логиниться, создавать инициативы, комментировать, оценивать атрибуты, назначать ответственного, фильтровать и сортировать список. Разделения прав нет.

## 3. Ключевые пользовательские сценарии
- US1: Создать инициативу — зафиксировать название и описание в Markdown.
- US2: Оценить инициативу — задать ценность, скорость реализации, стоимость (1–5).
- US3: Комментировать инициативу — вести обсуждение в виде чата.
- US4: Назначить ответственного — выбрать пользователя, отвечающего за инициативу.
- US5: Просмотреть список инициатив — отфильтровать (все/я предложил/назначено на меня) и отсортировать по весу.
- US6: Зарегистрироваться и войти — упрощённая регистрация, вход с JWT (TTL 24ч).

## 4. Функциональные требования (FR) и критерии приёмки (AC)

### FR1. Создание инициативы
- Поля: название (обяз.), описание Markdown (опц.), автор (системно), дата создания (системно).
- Валидации: название 1–140 символов; описание ≤ 10 000 символов, Markdown допускается.
- Действие: пользователь сохраняет инициативу; по умолчанию атрибуты оценок пустые.
- AC:
  1) При пустом названии показана ошибка и кнопка «Сохранить» не активна.
  2) После сохранения видно карточку инициативы с автором и датой.
  3) Markdown‑описание рендерится корректно (заголовки, списки, ссылки, код).
- Пример: «Бот для triage идей» с описанием в Markdown.

### FR2. Комментарии в формате чата
- Любой пользователь может добавлять сообщения; сообщения упорядочены по времени.
- Сообщение: текст 1–1 000 символов; запрещены пустые сообщения.
- AC:
  1) Новый комментарий появляется без перезагрузки списка (или после явного обновления).
  2) Автор, время и текст видимы; длинные сообщения переносятся.
  3) Пустой ввод — недоступна кнопка «Отправить».
- Пример: «Предлагаю добавить импорт из CSV».

### FR3. Атрибуты оценки инициативы (1–5)
- Атрибуты: ценность, скорость реализации, стоимость. Диапазон значений: 1 — «низкая» … 5 — «высокая».
- Любой пользователь может выставить/обновить значения для инициативы.
- Вычисление веса: фиксированная формула (см. раздел 6) на основании текущих атрибутов.
- AC:
  1) Контролы шкал принимают целые 1–5, значения сохраняются.
  2) При изменении значений пересчитывается и отображается вес.
  3) Значение вне диапазона не принимается, показана ошибка.
- Пример: ценность=5, скорость=4, стоимость=2.

### FR4. Назначение ответственного
- Поле «ответственный»: ссылка на пользователя; по умолчанию пусто.
- Любой пользователь может назначить/сменить ответственного.
- AC:
  1) В карточке отображается аватар/имя ответственного.
  2) Смена ответственного фиксируется и мгновенно отображается.
  3) Можно снять назначение (значение null).
- Пример: ответственный — «Мария Р.».

### FR5. Список инициатив: фильтры и сортировка
- Фильтры: «Все», «Я предложил», «Назначено на меня».
- Сортировка: по весу инициативы (по убыванию) по умолчанию; вторичная — по дате (новые сверху).
- AC:
  1) Переключение фильтра обновляет список корректно.
  2) Сортировка по весу стабильна при равенстве — учитывает дату.
  3) На мобильном помещается минимум 6 карточек при скролле без горизонтального скролла.
- Пример: список с активным фильтром «Я предложил», отсортирован по весу.

### FR6. Регистрация и вход
- Регистрация на экране логина: логин, отображаемое имя, пароль, подтверждение пароля.
- Валидации: логин 3–32 символа; имя 1–32; пароль 8–64; совпадение паролей.
- Аутентификация: JWT (TTL 24 часа) между frontend и backend; хранение токена в безопасном хранилище клиента.
- AC:
  1) Успешная регистрация автоматически авторизует пользователя и перенаправляет к списку.
  2) Ошибки валидации показаны инлайном под полями.
  3) При истечении токена требуется повторный вход.
- Пример: новый пользователь «alex», имя «Alex K». 

## 5. UX и состояния интерфейса
- Экраны: логин/регистрация; список инициатив; карточка инициативы; создание/редактирование; чат‑комментарии внизу карточки.
- Мобильный first: ширина 360–414 px, одно‑колоночный список карточек.
- Состояния: загрузка (скелетоны), пусто (приглашение «Создайте первую инициативу»), ошибка (toast + inline), успех (toast «Сохранено»).
- Контролы: инпут названия, Markdown‑textarea с предпросмотром, 3 шкалы 1–5 (радио/слайдер/звёзды), селект «Ответственный», фильтры‑табы, сортировка.

## 6. Данные и правила

### Сущности
- user, initiative, comment, rating (атрибуты оценки в карточке инициативы).

### initiative — поля
| имя | тип | обяз. | пример | примечание |
| --- | --- | --- | --- | --- |
| id | uuid | да | 3f1d… | системное |
| title | string(140) | да | Бот triage | уникальность в рамках автора не требуется |
| description | markdown string(10000) | нет | … | GitHub‑flavored подмножество |
| authorId | uuid -> user.id | да | … | автор инициативы |
| assigneeId | uuid -> user.id | нет | … | ответственный |
| createdAt | datetime | да | … | системное |
| updatedAt | datetime | да | … | системное |
| value | int (1..5) | нет | 5 | атрибут «ценность» |
| speed | int (1..5) | нет | 4 | атрибут «скорость реализации» |
| cost | int (1..5) | нет | 2 | атрибут «стоимость» |
| weight | number | да | 3.83 | вычисляемое сервером |

### comment — поля
| имя | тип | обяз. | пример | примечание |
| --- | --- | --- | --- | --- |
| id | uuid | да | … | системное |
| initiativeId | uuid -> initiative.id | да | … | привязка |
| authorId | uuid -> user.id | да | … | автор |
| text | string(1000) | да | «Предлагаю …» | без Markdown |
| createdAt | datetime | да | … | системное |

### user — поля
| имя | тип | обяз. | пример | примечание |
| --- | --- | --- | --- | --- |
| id | uuid | да | … | системное |
| login | string(32) | да | alex | уникальный |
| displayName | string(32) | да | Alex K | отображаемое имя |
| passwordHash | string | да | … | хранится хэш |
| createdAt | datetime | да | … | системное |

### Формула веса
- Предположение: высокая стоимость снижает приоритет; высокая скорость повышает приоритет.
- Формула: weight = round( (α·value + β·speed − γ·cost) / (α+β+γ), 2 ).
- Коэффициенты по умолчанию: α=0.5, β=0.3, γ=0.2. Диапазон результата условно 1..5.
- Пример: value=5, speed=4, cost=2 → weight = round((0.5·5 + 0.3·4 − 0.2·2)/1.0, 2) = 3.83.

### Сортировки и фильтры
- Сортировка по весу (desc), затем по createdAt (desc).
- Фильтры списка: all | mineCreated | assignedToMe.

## 7. Нефункциональные требования (простота и надёжность)
- Простота: минимум полей на экранах; ясные подписи/плейсхолдеры; предпросмотр Markdown.
- Надёжность: повторная отправка при сетевой ошибке; сохранение черновика описания локально до сабмита.
- Адаптивность: корректный layout 360–414 px; без горизонтального скролла; доступный контраст и размеры тач‑таргетов ≥ 44 px.
- Наблюдаемость: логирование ошибок на сервере; health‑check endpoint.

## 8. Ограничения и допущения
- Веб‑клиент + backend API; одна роль «пользователь» без разграничения прав.
- Аутентификация: JWT 24 часа. Хранение токена — в HTTP‑Only cookie или безопасном сторе, CSRF вне скоупа PRD.
- Реалтайм чат вне скоупа; допустима загрузка по запросу/пулами.
- Импорт/экспорт данных вне скоупа.
- Уведомления и интеграции вне скоупа.

---

## Чек‑лист готовности PRD
- [x] Сценарии покрыты FR с AC.
- [x] Поля и ограничения перечислены; примеры присутствуют.
- [x] Вычисления описаны формулой и примером.
- [x] NFR — только простота/надёжность/адаптивность/наблюдаемость.
- [x] Out of Scope определён.

---

## 9. Версия 2 (V2): Голосование, роли админов и верификация e‑mail

V2 расширяет возможности системы, не ломая текущие сценарии V1. Новые требования переопределяют соответствующие места V1 (роли/права, регистрация) и добавляют новые сценарии (голосование, сортировка по голосам).

### 9.1 Роли и разграничение прав
- Роли: пользователь (user), администратор (admin).
- Администраторы задаются через переменную окружения `ADMIN_EMAILS` (список e‑mail, через запятую). Роль определяется на сервере.
- Права:
  - Пользователь: создавать инициативы, комментировать, голосовать (палец вверх/вниз), просматривать ответственного и оценки (ценность/скорость/стоимость), но не изменять их.
  - Администратор: дополнительно может логически удалять любые инициативы и изменять поля `assignee`, `value`, `speed`, `cost`.
- Серверная авторизация обязательна: при попытке изменения админских полей не‑админ получает 403.

Изменение V1: раздел «Роли и персоны» теперь включает две роли; утверждение «Разделения прав нет» — недействительно для V2.

### 9.2 Голосование за инициативы
- Любой авторизованный пользователь может отдать ровно один голос за инициативу: «палец вверх» (up) или «палец вниз» (down). Повторный выбор меняет голос; можно снять голос.
- На карточке инициативы и в списке отображаются агрегаты: `upVotes`, `downVotes`, а также «оценка по голосам» `voteScore = upVotes − downVotes`.
- Сортировка списка может выполняться:
  - по весу инициативы (как в V1),
  - по голосам (`voteScore`, по убыванию).
- AC:
  1) Один пользователь — не более одного активного голоса на инициативу.
  2) Переключение up/down и снятие голоса отражается в агрегатах без рассинхронизации.
  3) Сортировка по голосам стабильно работает при равенстве — вторичная сортировка по дате.

### 9.3 Логическое удаление инициатив (только админы)
- Администратор может пометить инициативу как удалённую (`isDeleted = true`).
- Такие инициативы не отображаются в списках и недоступны по прямой ссылке (404), историю обсуждений можно сохранить для аудита (вне V2 UI).
- AC:
  1) Не‑админ получает 403 при попытке удаления.
  2) Удалённые записи не попадают в выборки API.

### 9.4 Регистрация: только @axenix.pro + подтверждение e‑mail кодом
- Регистрация доступна только для e‑mail в домене `@axenix.pro` (настраиваемо через `AXENIX_EMAIL_DOMAIN`, по умолчанию `axenix.pro`).
- Форма регистрации дополняется полями `email` и `emailCode` и кнопкой «Получить код».
- Процесс:
  1) Пользователь вводит `email` и жмёт «Получить код». Сервер генерирует одноразовый код (6 цифр), отправляет письмо через SMTP и сохраняет код с TTL (например, 10 минут). Ограничение частоты: не чаще 1 запроса в минуту на адрес.
  2) Пользователь вводит код и завершает регистрацию (сервер строго проверяет соответствие `email`↔`code`).
  3) При несовпадении домена, просрочке или неверном коде — регистрация отклоняется с ошибкой в форме; пользователь не создаётся.
- Поле `email` хранится в профиле пользователя; успешная регистрация помечает e‑mail подтверждённым.
- AC:
  1) E‑mail вне домена `@axenix.pro` — немедленная ошибка валидации.
  2) Код обязателен; без успешной верификации создание пользователя невозможно.
  3) Повторная отправка в пределах rate‑limit даёт понятное сообщение.

### 9.5 Отображение в UI (обновления)
- Список инициатив: на карточке видны `upVotes` и `downVotes`; добавлен переключатель сортировки: «по весу» / «по голосам».
- Детали инициативы: отображаются агрегаты голосов и текущий голос пользователя; контролы оценок (ценность/скорость/стоимость) и выбор ответственного недоступны для не‑админов (read‑only).

### 9.6 Данные и интеграции (влияние)
- Модель данных (высокоуровнево):
  - `initiatives.is_deleted boolean default false` — логическое удаление.
  - `users.email varchar unique not null`, `users.email_verified_at timestamptz null` — e‑mail и метка верификации.
  - `initiative_votes`: `id`, `initiative_id` FK, `user_id` FK, `value smallint in {-1,1}`, уникальный ключ `(initiative_id, user_id)`.
  - Агрегаты голосов считаются запросом; при необходимости — материализованный вид (вне V2).
  - Хранилище одноразовых кодов верификации: отдельная таблица в БД с TTL и rate‑limit (строго не in‑memory; коды должны переживать рестарты сервиса). Записи истёкших кодов могут удаляться периодическим процессом.
- API (высокоуровнево):
  - Расширить `Initiative` и списки полями `upVotes`, `downVotes`, `voteScore`.
  - Новый эндпоинт голосования: `POST /initiatives/{id}/vote` с телом `{ value: -1 | 0 | 1 }` (0 — снять голос).
  - Новый параметр сортировки списка: `sort=weight|votes`.
  - `DELETE /initiatives/{id}` — логическое удаление (403 для не‑админов).
  - Ограничить `PATCH /initiatives/{id}`: изменения `assigneeId`, `value`, `speed`, `cost` — только для админов (не‑админам 403).
  - Регистрация: добавить `POST /auth/request-email-code` и расширить `POST /auth/register` полями `email`, `emailCode` (строгая проверка на сервере).
- Интеграция e‑mail (SMTP):
  - Использовать SMTP сервер для отправки кода подтверждения.
  - Секреты вынести в `.env`:
    - `SMTP_HOST`, `SMTP_PORT`, `SMTP_USERNAME`, `SMTP_PASSWORD`, `SMTP_FROM`
    - `SMTP_TLS_SERVER_NAME` (если сертификат не совпадает с `SMTP_HOST`), `SMTP_TLS_INSECURE_SKIP_VERIFY` (только для отладки)
    - `ADMIN_EMAILS` (список e‑mail админов через запятую)
    - `AXENIX_EMAIL_DOMAIN=axenix.pro`
    - `EMAIL_CODES_TTL_MINUTES=10`

### 9.7 Риски и допущения
- Риск: злоупотребление запросом кода подтверждения — смягчается rate‑limit + троттлинг на сервере.
- Риск: рассинхронизация голосов при высокой нагрузке — минимизируется idempotent‑логикой (`upsert` по `(initiative_id, user_id)`).
- Допущение: изменение модели и API будет отражено в `db/schema.dbml` и `docs/openapi.yaml` в рамках реализации V2.

### 9.8 Критерии приёмки V2 (e2e)
1) Пользователь с e‑mail вне `@axenix.pro` не может зарегистрироваться.
2) Без верного кода подтверждения регистрация невозможна; с верным — успешна, пользователь авторизован.
3) На списке и в деталях видны `upVotes`/`downVotes`; голос пользователя учитывается корректно; переключение сортировки работает.
4) Не‑админ не может менять `assignee`, `value`, `speed`, `cost` и удалять инициативы (403).
5) Админ успешно логически удаляет инициативу; запись исчезает из всех списков и становится недоступной по id.

