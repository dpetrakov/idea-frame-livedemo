---
title: TK-001/AN — Детальная спецификация аутентификации (JWT 24h)
status: draft
lastUpdated: 2025-09-17
dependsOn:
  - docs/prd.md#fr7-регистрация-и-вход-аутентификация-jwt-24-часа
  - docs/architecture.md#регистрация-и-вход
  - db/schema.dbml#users
  - docs/openapi.yaml#/paths/~1v1~1auth~1register
  - docs/openapi.yaml#/paths/~1v1~1auth~1login
  - docs/openapi.yaml#/paths/~1v1~1users~1me
  - docs/openapi.yaml#/paths/~1v1~1health
  - docs/deployment.md#2-переменные-окружения-env
---

### Цель и результат

Обеспечить регистрацию, вход и идентификацию пользователя через JWT сроком 24 часа. После завершения:
- Регистрация и вход возвращают JWT и объект пользователя по контракту.
- Все защищённые запросы требуют `Authorization: Bearer <JWT>`.
- Эндпоинт `/v1/users/me` возвращает данные текущего пользователя.
- Эндпоинт `/v1/health` открыт (без security).

### Трассировка на артефакты
- PRD: `docs/prd.md#fr7-регистрация-и-вход-аутентификация-jwt-24-часа`
- Архитектура: `docs/architecture.md#регистрация-и-вход`
- OpenAPI: `docs/openapi.yaml#/paths/~1v1~1auth~1register`, `#/paths/~1v1~1auth~1login`, `#/paths/~1v1~1users~1me`, `#/paths/~1v1~1health`
- DBML: `db/schema.dbml#users`
- Deployment: `docs/deployment.md#2-переменные-окружения-env` (переменная `JWT_SECRET`)

### Общее поведение и потоки

1) Регистрация (`POST /v1/auth/register`):
- Вход: `RegisterRequest { login, displayName, password, passwordConfirm }`.
- Валидации: `login` ≤ 64, `displayName` ≤ 140, `password` ≥ 8, `passwordConfirm == password`.
- Бизнес‑правила: `login` уникален; пароль хэшируется `bcrypt` (рекомендованный cost 10–12).
- Ответ: `201` с `AuthResponse { token (TTL 24h), user }`.
- Ошибки: `400` (невалидный JSON), `409` (дубликат логина), `422` (валидация), `500`.

2) Вход (`POST /v1/auth/login`):
- Вход: `LoginRequest { login, password }`.
- Проверка: поиск пользователя по `login`, сравнение пароля с `password_hash` (`bcrypt`).
- Ответ: `200` с `AuthResponse`.
- Ошибки: `401` (неверные креды), `422` (валидация), `500`.

3) Текущий пользователь (`GET /v1/users/me`):
- Требует `Authorization: Bearer <JWT>`.
- Ответ: `200` `User { id, login, displayName, createdAt, updatedAt }`; `401` при невалидном/просроченном токене.

4) Health (`GET /v1/health`):
- Открыт (в `openapi.yaml` установлен `security: []`). Ответ `200` с `{ status: "ok" }`.

### Контракты API (выжимка из OpenAPI)
- `POST /v1/auth/register` — `RegisterRequest` → `201 AuthResponse`.
- `POST /v1/auth/login` — `LoginRequest` → `200 AuthResponse`.
- `GET /v1/users/me` — → `200 User`.
- Общее `security: bearerAuth` (за исключением `register`, `login`, `health`).

Схемы:
- `User`: `id(uuid)`, `login`, `displayName`, `createdAt`, `updatedAt`.
- `AuthResponse`: `token` (JWT TTL 24h), `user` (`User`).
- Ошибки: `Error { code, message, details?, correlationId? }` через стандартные ответы.

### Модель данных (DBML → SQL)
- Таблица `users` (`db/schema.dbml`):
  - Поля: `id uuid pk`, `login varchar(64) unique not null`, `display_name varchar(140) not null`, `password_hash varchar(255) not null`, `created_at timestamptz not null default now()`, `updated_at timestamptz not null default now()`.
  - Индекс уникальности на `login` обязателен.
- Отображение на JSON:
  - `display_name` → `displayName`
  - `created_at` → `createdAt`, `updated_at` → `updatedAt`

### JWT и безопасность
- Алгоритм: HS256; секрет в переменной окружения `JWT_SECRET`.
- TTL: 24 часа (`exp = iat + 86400`). Часовой пояс — UTC.
- Рекомендуемые клаймы: `sub` = `user.id` (UUID), `iat`, `exp`, `login` (опционально для трассировки).
- Формат заголовка: `Authorization: Bearer <token>`.
- Валидация: подпись, `exp`, соответствие `sub` существующему пользователю.

### Валидации и ошибки
- Регистрация:
  - `login`: непустой, длина ≤ 64; конфликт (409) при занятом логине.
  - `displayName`: непустой, длина ≤ 140.
  - `password`: длина ≥ 8; `passwordConfirm` совпадает.
  - Ответы ошибок: `422` со списком полей в `details`.
- Вход:
  - Ошибка `401` с кодом `UNAUTHORIZED` при неверных кредах (без уточнения что неверно).
- Общие: `500` для неожиданных ошибок; включать `correlationId`.

### Логи и наблюдаемость
- Логировать: попытки логина (warn при неуспехе), успешную регистрацию (info), генерацию токена (debug без токена). Не логировать пароли и токены.
- Health: `/v1/health` возвращает `200`; включить минимальную информацию `{ status: "ok" }`.

### UX состояния (для справки FE)
- Экран логина/регистрации: состояния `loading`, `error` (toast/inline), `success` (редирект в список).
- Ошибки валидации: подсветка полей с сообщениями.
- Авто‑логин после регистрации: использовать `AuthResponse.token` как после логина.

### Критерии приёмки (соответствие DoD TK-001)
- В `openapi.yaml` описаны `/v1/auth/register`, `/v1/auth/login`, `/v1/users/me`; глобальная `security: bearerAuth`, а для `register/login/health` — `security: []`.
- В `db/schema.dbml` существует `users` с полями: `id`, `login(unique)`, `display_name`, `password_hash`, `created_at`, `updated_at`.
- Бэкенд должен хешировать пароли `bcrypt` и выдавать JWT TTL 24h.
- `/v1/health` отдаёт 200 OK без авторизации.

### Нерешённые вопросы/границы
- Политика сложности пароля — вне текущего объёма (минимум 8 символов).
- Механизм refresh‑токенов — вне объёма (срок жизни 24 часа).


